openapi: 3.0.3
info:
  title: Patchify Settings API
  description: |
    API specification for the Patchify Settings Module.
    Includes endpoints for Branch Location, User Management, Roles & Privileges, and Policies.

    This specification follows REST principles and uses standard HTTP methods and status codes.
  version: 1.0.0
  contact:
    name: Patchify Development Team

servers:
  - url: http://localhost:3000/api
    description: Local development server
  - url: https://api.patchify.com/api
    description: Production server

tags:
  - name: Branches
    description: Branch location management endpoints
  - name: Users
    description: User management endpoints
  - name: Roles
    description: Role and privilege management endpoints
  - name: Policies
    description: Policy management endpoints

paths:
  # ==================== BRANCH ENDPOINTS ====================
  /settings/branches:
    get:
      tags:
        - Branches
      summary: Get all branches
      description: Retrieve a list of all branch locations
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Branch'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Branches
      summary: Create a new branch
      description: |
        Create a new branch location.
        If isDefault is true, all other branches will have their isDefault flag set to false.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BranchInput'
      responses:
        '201':
          description: Branch created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Branch'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /settings/branches/{id}:
    get:
      tags:
        - Branches
      summary: Get a branch by ID
      parameters:
        - $ref: '#/components/parameters/BranchId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Branch'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Branches
      summary: Update a branch
      description: |
        Update an existing branch.
        If isDefault is set to true, all other branches will have their isDefault flag set to false.
      parameters:
        - $ref: '#/components/parameters/BranchId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BranchInput'
      responses:
        '200':
          description: Branch updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Branch'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Branches
      summary: Delete a branch
      description: |
        Delete a branch.
        Cannot delete the default branch (will return 400 error).
      parameters:
        - $ref: '#/components/parameters/BranchId'
      responses:
        '204':
          description: Branch deleted successfully
        '400':
          description: Cannot delete default branch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== USER ENDPOINTS ====================
  /settings/users:
    get:
      tags:
        - Users
      summary: Get all users
      description: Retrieve a list of all users
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Users
      summary: Create a new user
      description: Create a new user account with full details
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /settings/users/{id}:
    get:
      tags:
        - Users
      summary: Get a user by ID
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Users
      summary: Update a user
      parameters:
        - $ref: '#/components/parameters/UserId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Users
      summary: Delete a user
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '204':
          description: User deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'

  /settings/users/invite:
    post:
      tags:
        - Users
      summary: Invite a new user
      description: |
        Send an email invitation to a new user.
        Creates a user account in 'Invite Sent' status with a 7-day expiration token.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InviteUserInput'
      responses:
        '201':
          description: Invitation sent successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /settings/users/{id}/reset-password:
    post:
      tags:
        - Users
      summary: Reset user password
      description: Send a password reset link to the user's email
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: Password reset link sent successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /settings/users/{id}/suspend:
    post:
      tags:
        - Users
      summary: Suspend a user account
      description: Suspend a user account, changing status to 'In Active'
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: User suspended successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'

  /settings/users/{id}/audit-log:
    get:
      tags:
        - Users
      summary: Get user audit log
      description: Retrieve the audit log for a specific user
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AuditLogEntry'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== ROLE ENDPOINTS ====================
  /settings/roles:
    get:
      tags:
        - Roles
      summary: Get all roles
      description: Retrieve a list of all roles with their permissions
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Role'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Roles
      summary: Create a new role
      description: Create a new role with custom permissions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleInput'
      responses:
        '201':
          description: Role created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /settings/roles/{id}:
    get:
      tags:
        - Roles
      summary: Get a role by ID
      parameters:
        - $ref: '#/components/parameters/RoleId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Roles
      summary: Update a role
      description: |
        Update an existing role.
        System roles (isSystem: true) cannot have their names changed.
      parameters:
        - $ref: '#/components/parameters/RoleId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleInput'
      responses:
        '200':
          description: Role updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Roles
      summary: Delete a role
      description: |
        Delete a role.
        Cannot delete system roles (Admin, Team Manager, Employee).
      parameters:
        - $ref: '#/components/parameters/RoleId'
      responses:
        '204':
          description: Role deleted successfully
        '400':
          description: Cannot delete system role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== POLICY ENDPOINTS ====================
  /settings/policies:
    get:
      tags:
        - Policies
      summary: Get all policies
      description: Retrieve a list of all policies
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Policy'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Policies
      summary: Create a new policy
      description: Create a new policy with type-specific configuration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PolicyInput'
      responses:
        '201':
          description: Policy created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Policy'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /settings/policies/{id}:
    get:
      tags:
        - Policies
      summary: Get a policy by ID
      parameters:
        - $ref: '#/components/parameters/PolicyId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Policy'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Policies
      summary: Update a policy
      parameters:
        - $ref: '#/components/parameters/PolicyId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PolicyInput'
      responses:
        '200':
          description: Policy updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Policy'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Policies
      summary: Delete a policy
      parameters:
        - $ref: '#/components/parameters/PolicyId'
      responses:
        '204':
          description: Policy deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'

  /settings/policies/{id}/clone:
    post:
      tags:
        - Policies
      summary: Clone a policy
      description: Create a copy of an existing policy with a new name
      parameters:
        - $ref: '#/components/parameters/PolicyId'
      responses:
        '201':
          description: Policy cloned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Policy'
        '404':
          $ref: '#/components/responses/NotFound'

  /settings/policies/{id}/disable:
    post:
      tags:
        - Policies
      summary: Disable a policy
      description: Set policy status to 'Inactive'
      parameters:
        - $ref: '#/components/parameters/PolicyId'
      responses:
        '200':
          description: Policy disabled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Policy'
        '404':
          $ref: '#/components/responses/NotFound'

  /settings/policies/{id}/affected-users:
    get:
      tags:
        - Policies
      summary: Get users affected by a policy
      description: Retrieve all users affected by a specific policy based on their roles
      parameters:
        - $ref: '#/components/parameters/PolicyId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'

  /settings/policies/{id}/audit:
    get:
      tags:
        - Policies
      summary: Get policy audit history
      description: Retrieve the audit log for a specific policy
      parameters:
        - $ref: '#/components/parameters/PolicyId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AuditLogEntry'
        '404':
          $ref: '#/components/responses/NotFound'

# ==================== COMPONENTS ====================
components:
  parameters:
    BranchId:
      name: id
      in: path
      required: true
      description: Branch ID
      schema:
        type: string
        format: uuid

    UserId:
      name: id
      in: path
      required: true
      description: User ID
      schema:
        type: string
        format: uuid

    RoleId:
      name: id
      in: path
      required: true
      description: Role ID
      schema:
        type: string
        format: uuid

    PolicyId:
      name: id
      in: path
      required: true
      description: Policy ID
      schema:
        type: string
        format: uuid

  schemas:
    # ==================== BRANCH SCHEMAS ====================
    Branch:
      type: object
      required:
        - id
        - name
        - status
        - users
        - assets
        - isDefault
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          example: "Gurugram"
        status:
          type: string
          enum: [Default, Active, Inactive]
          example: "Default"
        users:
          type: integer
          description: Number of users assigned to this branch
          example: 45
        assets:
          type: integer
          description: Number of assets assigned to this branch
          example: 150
        address:
          type: string
          example: "123 Business Park, Sector 44"
        city:
          type: string
          example: "Gurugram"
        state:
          type: string
          example: "Haryana"
        country:
          type: string
          example: "India"
        postalCode:
          type: string
          example: "122001"
        phone:
          type: string
          example: "+91-124-1234567"
        email:
          type: string
          format: email
          example: "branch.gurugram@patchify.com"
        manager:
          type: string
          description: User ID of the branch manager
          example: "user1"
        isDefault:
          type: boolean
          description: Whether this is the default branch
          example: true
        description:
          type: string
          example: "Main headquarters branch"

    BranchInput:
      type: object
      required:
        - name
        - manager
      properties:
        name:
          type: string
        address:
          type: string
        city:
          type: string
        state:
          type: string
        country:
          type: string
        postalCode:
          type: string
        phone:
          type: string
        email:
          type: string
          format: email
        manager:
          type: string
        isDefault:
          type: boolean
          default: false
        description:
          type: string

    # ==================== USER SCHEMAS ====================
    User:
      type: object
      required:
        - id
        - firstName
        - lastName
        - email
        - branch
        - role
        - status
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        firstName:
          type: string
          example: "Rajesh"
        lastName:
          type: string
          example: "Kumar"
        email:
          type: string
          format: email
          example: "rajesh.kumar@patchify.com"
        phone:
          type: string
          example: "+91-9876543210"
        branch:
          type: string
          example: "Gurugram"
        role:
          type: string
          example: "Admin"
        status:
          type: string
          enum: [Active, Invite Sent, New Account, In Active]
          example: "Active"
        lastLogin:
          type: string
          example: "2 hours ago"
        avatar:
          type: string
          format: uri
          nullable: true
        createdAt:
          type: string
          format: date-time
        gender:
          type: string
          enum: [Male, Female, Others]
          nullable: true
        timezone:
          type: string
          example: "IST"
        orgUnit:
          type: string
          example: "IT"
        dashboard:
          type: string
          example: "overview"

    UserInput:
      type: object
      required:
        - firstName
        - lastName
        - email
        - branch
        - role
      properties:
        firstName:
          type: string
        lastName:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        branch:
          type: string
        role:
          type: string
        password:
          type: string
          format: password
          description: Required for new users, optional for updates
        gender:
          type: string
          enum: [Male, Female, Others]
        timezone:
          type: string
        orgUnit:
          type: string
        dashboard:
          type: string

    InviteUserInput:
      type: object
      required:
        - email
        - role
        - orgUnit
        - dashboard
      properties:
        email:
          type: string
          format: email
        role:
          type: string
        orgUnit:
          type: string
        dashboard:
          type: string
        message:
          type: string
          description: Optional personal message to include in invitation

    # ==================== ROLE SCHEMAS ====================
    Role:
      type: object
      required:
        - id
        - name
        - description
        - users
        - branch
        - permissions
        - isSystem
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: "Admin"
        description:
          type: string
          example: "Full system access with all permissions"
        users:
          type: integer
          description: Number of users with this role
          example: 5
        branch:
          type: string
          example: "Gurugram"
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/Permission'
        isSystem:
          type: boolean
          description: Whether this is a system role (cannot be deleted)
          example: true

    RoleInput:
      type: object
      required:
        - name
        - description
        - branch
        - permissions
      properties:
        name:
          type: string
        description:
          type: string
        branch:
          type: string
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/Permission'

    Permission:
      type: object
      required:
        - module
        - actions
      properties:
        module:
          type: string
          enum: [patches, assets, discovery, reports, settings]
          example: "patches"
        actions:
          type: array
          items:
            type: string
            enum: [view, add, edit, delete]
          example: ["view", "edit"]

    # ==================== POLICY SCHEMAS ====================
    Policy:
      type: object
      required:
        - id
        - name
        - type
        - orgUnit
        - users
        - description
        - configuration
        - status
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: "Strong Password Policy"
        type:
          type: string
          enum: [password, security, backup, update, access, compliance]
          example: "password"
        orgUnit:
          type: string
          example: "Gurugram"
        users:
          type: integer
          description: Number of users affected by this policy
          example: 45
        description:
          type: string
          example: "Enforces strong password requirements for all users"
        configuration:
          type: object
          description: Type-specific configuration (structure varies by policy type)
          additionalProperties: true
          example:
            minLength: 8
            requireUppercase: true
            requireLowercase: true
            requireNumbers: true
            requireSpecialChars: true
            expiryDays: 90
            preventReuse: 5
        affectedRoles:
          type: array
          items:
            type: string
          example: ["Admin", "Team Manager", "Employee"]
        effectiveDate:
          type: string
          format: date-time
          nullable: true
        status:
          type: string
          enum: [Active, Inactive, Draft]
          example: "Active"
        createdBy:
          type: string
          example: "admin@patchify.com"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    PolicyInput:
      type: object
      required:
        - name
        - type
        - orgUnit
        - description
        - configuration
      properties:
        name:
          type: string
        type:
          type: string
          enum: [password, security, backup, update, access, compliance]
        orgUnit:
          type: string
        description:
          type: string
        configuration:
          type: object
          additionalProperties: true
        affectedRoles:
          type: array
          items:
            type: string
        effectiveDate:
          type: string
          format: date-time
        status:
          type: string
          enum: [Active, Inactive, Draft]
          default: Active

    # ==================== COMMON SCHEMAS ====================
    AuditLogEntry:
      type: object
      required:
        - id
        - action
        - performedBy
        - timestamp
      properties:
        id:
          type: string
          format: uuid
        action:
          type: string
          example: "User suspended by admin"
        performedBy:
          type: string
          example: "admin@patchify.com"
        timestamp:
          type: string
          format: date-time
        details:
          type: object
          additionalProperties: true

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          example: "Bad Request"
        message:
          type: string
          example: "Cannot delete the default branch"
        details:
          type: object
          additionalProperties: true

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Not Found"
            message: "Resource not found"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Internal Server Error"
            message: "An unexpected error occurred"
